name: Build Task MacOS
on:
  workflow_call:
    inputs:
      name:
        required: true
        type: string
      enable:
        required: true
        type: boolean
        default: true
      runs-on:
        required: true
        type: string
      python-version:
        required: true
        type: string
      arch:
        required: true
        type: string
      python-arch:
        required: true
        type: string
      freethreaded:
        required: false
        type: boolean
        default: false
      build-type:
        required: true
        type: string
      debug: 
        required: false
        type: boolean
        default: false

jobs:
  build:
    if: inputs.enable && inputs.runs-on == 'macos-latest'
    runs-on: ${{ inputs.runs-on }}
    defaults:
      run:
        shell: bash
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python ${{ inputs.python-version }} (${{ inputs.python-arch }})
      id: setup-python
      uses: actions/setup-python@v6
      with:
        python-version: ${{ inputs.python-version }}
        cache: pip
        architecture: ${{ inputs.python-arch }}
        freethreaded: ${{ inputs.freethreaded && true || false }}
    
    - name: Install Dependencies
      run: |
        PYTHON="${{ steps.setup-python.outputs.python-path }}"
        $PYTHON -m pip install --upgrade pip
        $PYTHON -m pip install .[extend,${{ inputs.build-type }}]
    
    - name: Build by ${{ inputs.build-type }} (${{ inputs.debug && 'Debug' || 'Release' }})
      run: |
        cp ./OlivOS/hook.py ./OlivOS/hook_bak.py
        cp ./OlivOS/hook_pack_debug.py ./OlivOS/hook.py
        if [[ ${{ inputs.build-type == 'pyinstaller' && '1' || '0' }} -eq 1 ]]; then
          $PYTHON -m pyinstaller ./OlivOS.spec
        elif [[ ${{ inputs.build-type == 'nuitka' && '1' || '0' }} -eq 1 ]]; then
          $PYTHON ./script/nuitka_build.py
        fi
        mkdir OlivOS-PKG
        cp ./dist/OlivOS* ./OlivOS-PKG/
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.name }}
        path: ./OlivOS-PKG
    
    - name: Upload Publish Artifact
      uses: actions/upload-artifact@v4
      if: inputs.name == 'OlivOS-MacOS64-release'
      with:
        name: OlivOS-MacOS
        path: ./OlivOS-PKG
